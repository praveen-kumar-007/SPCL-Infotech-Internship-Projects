<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate - Admin Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans">

    <header class="bg-blue-800 text-white p-6 shadow-lg mb-8">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold tracking-tight">Real Estate Portal <span class="text-sm font-light text-blue-200">Backend Tester</span></h1>
            <div class="flex items-center gap-4">
                <div id="authBadge" class="bg-blue-700 px-4 py-2 rounded-full text-sm">Status: Not Logged In</div>
                <button onclick="logout()" id="logoutBtn" class="hidden bg-red-600 hover:bg-red-700 px-4 py-2 rounded-full text-sm font-bold transition">Logout</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 pb-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-xl font-semibold mb-4 text-slate-800">1. Register User</h2>
                    <div class="space-y-3">
                        <input id="regName" type="text" placeholder="Full Name" class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <input id="regEmail" type="email" placeholder="Email Address" class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <input id="regPass" type="password" placeholder="Password" class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <input id="regPhone" type="text" placeholder="Phone Number" class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="regRole" class="w-full p-2 border rounded-lg bg-white outline-none">
                            <option value="buyer">Buyer</option>
                            <option value="seller">Seller</option>
                        </select>
                        <button onclick="register()" class="w-full bg-slate-800 text-white py-2 rounded-lg hover:bg-slate-900 transition font-bold">Create Account</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-xl font-semibold mb-4 text-slate-800">2. Login</h2>
                    <div class="space-y-3">
                        <input id="loginEmail" type="email" placeholder="Email" class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <input id="loginPass" type="password" placeholder="Password" class="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-bold">Get Access Token</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-xl font-semibold mb-4 text-slate-800">3. Post New Property</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="pTitle" type="text" placeholder="Property Title" class="p-2 border rounded-lg outline-none focus:ring-2 focus:ring-green-500">
                        <input id="pPrice" type="number" placeholder="Price (USD)" class="p-2 border rounded-lg outline-none focus:ring-2 focus:ring-green-500">
                        <input id="pCity" type="text" placeholder="City" class="p-2 border rounded-lg outline-none focus:ring-2 focus:ring-green-500">
                        <select id="pType" class="p-2 border rounded-lg bg-white outline-none focus:ring-2 focus:ring-green-500">
                            <option value="house">House</option>
                            <option value="apartment">Apartment</option>
                            <option value="commercial">Commercial</option>
                        </select>
                        <textarea id="pDesc" placeholder="Description" class="md:col-span-2 p-2 border rounded-lg h-24 outline-none focus:ring-2 focus:ring-green-500"></textarea>
                        <button onclick="addProperty()" class="md:col-span-2 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">List Property</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-xl font-semibold text-slate-800">4. Property Explorer</h2>
                        <div class="flex gap-2 w-full md:w-auto">
                            <input id="searchQuery" oninput="fetchProperties()" type="text" placeholder="Search by city..." class="p-2 border rounded-lg text-sm flex-grow outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="fetchProperties()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-bold">Refresh</button>
                        </div>
                    </div>

                    <div id="propertyList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CRITICAL FOR RENDER: Use dynamic origin instead of localhost
        const API_URL = window.location.origin + '/api';
        let authToken = localStorage.getItem('token') || '';

        function updateUI() {
            const badge = document.getElementById('authBadge');
            const logoutBtn = document.getElementById('logoutBtn');
            if(authToken) {
                badge.innerText = "Status: Logged In ‚úÖ";
                badge.className = "bg-green-700 px-4 py-2 rounded-full text-sm";
                logoutBtn.classList.remove('hidden');
            } else {
                badge.innerText = "Status: Not Logged In";
                badge.className = "bg-blue-700 px-4 py-2 rounded-full text-sm";
                logoutBtn.classList.add('hidden');
            }
        }

        function logout() {
            authToken = '';
            localStorage.removeItem('token');
            updateUI();
            alert("Logged out!");
        }

        async function register() {
            const userData = {
                name: document.getElementById('regName').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPass').value,
                phoneNumber: document.getElementById('regPhone').value,
                role: document.getElementById('regRole').value
            };

            const res = await fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
            const data = await res.json();
            if(data.success) alert("Success! Now please Login.");
            else alert("Error: " + data.message);
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPass').value;

            const res = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if(data.success) {
                authToken = data.token;
                localStorage.setItem('token', data.token);
                updateUI();
                alert("Login Successful!");
                fetchProperties();
            } else {
                alert("Login Failed: " + data.message);
            }
        }

        async function addProperty() {
            if(!authToken) return alert("Please login first!");

            const propertyData = {
                title: document.getElementById('pTitle').value,
                price: document.getElementById('pPrice').value,
                location: { city: document.getElementById('pCity').value },
                propertyType: document.getElementById('pType').value,
                description: document.getElementById('pDesc').value
            };

            const res = await fetch(`${API_URL}/properties`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(propertyData)
            });
            const data = await res.json();
            if(data.success) {
                alert("Property Added!");
                fetchProperties();
            } else alert("Error: " + data.message);
        }

        async function sendInquiry(propertyId) {
            if(!authToken) return alert("Login to send inquiries!");
            const message = prompt("Enter your message for the seller:");
            if(!message) return;

            const res = await fetch(`${API_URL}/inquiries`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ propertyId, message })
            });
            const data = await res.json();
            if(data.success) alert("Inquiry sent to seller!");
            else alert("Error: " + data.message);
        }

        async function fetchProperties() {
            const search = document.getElementById('searchQuery').value;
            const url = search ? `${API_URL}/properties?search=${search}` : `${API_URL}/properties`;
            
            const res = await fetch(url);
            const json = await res.json();
            const list = document.getElementById('propertyList');
            
            if(!json.data || json.data.length === 0) {
                list.innerHTML = '<p class="text-gray-400 italic">No properties found.</p>';
                return;
            }

            list.innerHTML = json.data.map(p => `
                <div class="border border-slate-200 p-4 rounded-xl bg-slate-50 hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-slate-800 uppercase text-xs tracking-wider">${p.title}</h3>
                        <span class="bg-blue-100 text-blue-800 text-[10px] font-bold px-2 py-1 rounded">${p.propertyType}</span>
                    </div>
                    <p class="text-2xl font-black text-green-600 mb-1">$${Number(p.price).toLocaleString()}</p>
                    <p class="text-sm text-slate-500">üìç ${p.location.city}</p>
                    <button onclick="sendInquiry('${p._id}')" class="mt-4 w-full bg-slate-800 text-white py-2 rounded text-xs font-bold hover:bg-slate-700 transition">
                        Contact Seller
                    </button>
                    <div class="mt-3 pt-3 border-t text-[10px] text-slate-400">
                        Seller: ${p.owner ? p.owner.name : 'Unknown'}
                    </div>
                </div>
            `).join('');
        }

        // Initial Setup
        updateUI();
        fetchProperties();
    </script>
</body>
</html>